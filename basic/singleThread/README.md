# 單執行緒架構

<br>

---

<br>

Redis 使用單執行緒架構，本篇有 2 個種點：

1. 透過多個客戶端 cli 命令調用說明 Redis 的單執行緒機制

2. 分析 Redis 的單執行緒性能為什麼高

<br>
<br>

<br>
<br>

## 引出單執行緒模型

<br>

開啟 3 個 redis-cli 客戶端同時執行命令：

cli-1：

```
127.0.0.1:6380> set hello world
OK
```

cli-2：

```
127.0.0.1:6380> incr counter
(integer) 1
```

cli-3：

```
127.0.0.1:6380> incr counter
(integer) 2
```

<br>
<br>

對多執行緒有概念的話，或許會對 `incr` 有一些疑慮，如果是多 Thread 情境下，要如何確保資料的一致性，寫操作的原子性都是需要考量的點。

Redis 是單 Thread 架構來處理所有客戶端送來的請求操作，所以 __每個客戶端送來的請求都會進到隊列，然後逐個被執行__ 。所以上面 3 個指令同時發出後，執行並不是同時，而是按照接收到的順序執行。所以也不用擔心資料的正確性。

<br>
<br>
<br>
<br>

## 為什麼單執行緒還可以這麼快？

<br>

1. 純內存訪問，Redis 把所有資料放在內存中，內存響應時間大約落在 100 ns，這就是 Redis 達到每秒萬級單位訪問的基礎。

2. 使用非組塞 I/O，Redis 用 epoll 作為 I/O 多路復用技術實現。

    epoll 是一個在 Linux 操作系統中實現高效 I/O 多路復用的機制。它是一種基於事件驅動的模型，通過監視一組文件描述符來確定哪些文件描述符可以進行 I/O 操作，從而 __避免了常規 I/O 操作中的阻塞等待。總之，epoll 是一種高效的 I/O 多路復用機制，適用於大規模、高並發的網絡編程場景。__[（更多關於 epoll 請點這裡了解）](./epoll.md)。Redis 因為使用 epoll 而會在網路 I/O 上浪費時間。

3. 單執行緒避免線程切換和資源競爭產生的內部消耗。

<br>
<br>
<br>
<br>

## 單執行緒的好處與壞處

<br>

### 好處：

<br>

1. 簡化資料結構與演算法實現，高併發的資料結構與算法不但困難而且難以開發測試。

2. 單執行緒避免線程切換和資源競爭產生的內部消耗（鎖與線程切換是性能殺手）

<br>
<br>

### 壞處：

<br>

1. 若單一命令執行時間過長，會倒至後續請求全部延宕
